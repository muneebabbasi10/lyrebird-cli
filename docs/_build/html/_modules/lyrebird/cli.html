

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lyrebird.cli &mdash; Lyrebird CLI Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            lyrebird-cli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lyrebird-cli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">lyrebird.cli</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lyrebird.cli</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Lyrebird CLI: An AI-Powered Coding Assistant in Your Terminal</span>
<span class="sd">Main CLI module using Typer framework</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">import</span> <span class="nn">typer</span>
<span class="kn">import</span> <span class="nn">ollama</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
<span class="kn">from</span> <span class="nn">rich.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">rich.syntax</span> <span class="kn">import</span> <span class="n">Syntax</span>
<span class="kn">from</span> <span class="nn">rich.panel</span> <span class="kn">import</span> <span class="n">Panel</span>
<span class="kn">from</span> <span class="nn">rich.progress</span> <span class="kn">import</span> <span class="n">Progress</span><span class="p">,</span> <span class="n">SpinnerColumn</span><span class="p">,</span> <span class="n">TextColumn</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>

<span class="c1"># Initialize Rich console for better output formatting</span>
<span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

<span class="c1"># Configure logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)],</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Provider">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.Provider">[docs]</a>
<span class="k">class</span> <span class="nc">Provider</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">openrouter</span> <span class="o">=</span> <span class="s2">&quot;openrouter&quot;</span>
    <span class="n">deepseek</span> <span class="o">=</span> <span class="s2">&quot;deepseek&quot;</span>
    <span class="n">ollama</span> <span class="o">=</span> <span class="s2">&quot;ollama&quot;</span></div>



<div class="viewcode-block" id="OutputFormat">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.OutputFormat">[docs]</a>
<span class="k">class</span> <span class="nc">OutputFormat</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
    <span class="n">json</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span></div>



<div class="viewcode-block" id="LyrebirdClient">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.LyrebirdClient">[docs]</a>
<span class="k">class</span> <span class="nc">LyrebirdClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Client for interacting with Large Language Model (LLM) APIs.</span>

<span class="sd">    This class provides a unified interface to interact with different LLM providers</span>
<span class="sd">    including OpenRouter, DeepSeek, and Ollama. It handles authentication, model selection,</span>
<span class="sd">    and request formatting.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        provider (Provider): The LLM service provider to use</span>
<span class="sd">        verbose (bool): Flag to enable verbose logging</span>
<span class="sd">        model (str): The specific model to use for requests</span>
<span class="sd">        client (Union[OpenAI, ollama]): The client instance for the selected provider</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; client = LyrebirdClient(Provider.ollama, model=&quot;codellama&quot;, verbose=True)</span>
<span class="sd">        &gt;&gt;&gt; response = client.make_request(&quot;System prompt&quot;, &quot;User query&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Lyrebird client for a specific LLM provider.</span>

<span class="sd">        Sets up the API client based on the selected provider, handles authentication</span>
<span class="sd">        using environment variables, and configures default models. Also sets up</span>
<span class="sd">        logging verbosity based on the verbose flag.</span>

<span class="sd">        Args:</span>
<span class="sd">            provider: The LLM service provider to use (openrouter, deepseek, or ollama)</span>
<span class="sd">            model: Optional specific model name. Defaults to provider&#39;s recommended model:</span>
<span class="sd">                - openrouter: &quot;openai/gpt-4&quot;</span>
<span class="sd">                - deepseek: &quot;deepseek-chat&quot;</span>
<span class="sd">                - ollama: &quot;codellama&quot;</span>
<span class="sd">            verbose: Enable verbose logging if True (default: False)</span>

<span class="sd">        Raises:</span>
<span class="sd">            typer.Exit(1): If required API key environment variables are not set for:</span>
<span class="sd">                - OpenRouter: OPENROUTER_API_KEY</span>
<span class="sd">                - DeepSeek: DEEPSEEK_API_KEY</span>

<span class="sd">        Environment Variables:</span>
<span class="sd">            OPENROUTER_API_KEY: API key for OpenRouter service</span>
<span class="sd">            DEEPSEEK_API_KEY: API key for DeepSeek service</span>

<span class="sd">        Note:</span>
<span class="sd">            Ollama doesn&#39;t require API keys as it runs locally</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; client = LyrebirdClient(Provider.openrouter, verbose=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="n">Provider</span><span class="o">.</span><span class="n">openrouter</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENROUTER_API_KEY&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="s2">&quot;[red]Error: OPENROUTER_API_KEY environment variable not set[/red]&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
                <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://openrouter.ai/api/v1&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">or</span> <span class="s2">&quot;openai/gpt-4&quot;</span>

        <span class="k">elif</span> <span class="n">provider</span> <span class="o">==</span> <span class="n">Provider</span><span class="o">.</span><span class="n">deepseek</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="s2">&quot;[red]Error: DEEPSEEK_API_KEY environment variable not set[/red]&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://api.deepseek.com&quot;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">or</span> <span class="s2">&quot;deepseek-chat&quot;</span>

        <span class="k">elif</span> <span class="n">provider</span> <span class="o">==</span> <span class="n">Provider</span><span class="o">.</span><span class="n">ollama</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">ollama</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">or</span> <span class="s2">&quot;codellama&quot;</span>

            <span class="c1"># Check and pull Ollama model if needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_ollama_model_exists</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized </span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2"> client with model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_ollama_model_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures the specified Ollama model is available locally, pulling it if necessary.</span>

<span class="sd">        This method checks for the local presence of the required Ollama model.</span>
<span class="sd">        If the model is not found, it initiates a download from the Ollama registry.</span>
<span class="sd">        Error handling is included for cases where model verification or pulling fails.</span>

<span class="sd">        Raises:</span>
<span class="sd">            typer.Exit(1): If the model cannot be verified or successfully pulled.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method is automatically invoked during the initialization of the</span>
<span class="sd">            `LyrebirdClient` when using the Ollama provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if model exists locally</span>
            <span class="n">local_models</span> <span class="o">=</span> <span class="n">ollama</span><span class="o">.</span><span class="n">list</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">model_exists</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">local_models</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_exists</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[yellow]Model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; not found locally. Pulling from Ollama...[/yellow]&quot;</span>
                <span class="p">)</span>

                <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
                    <span class="n">SpinnerColumn</span><span class="p">(),</span>
                    <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">transient</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pulling </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># Stream the pull progress</span>
                    <span class="k">for</span> <span class="n">progress_info</span> <span class="ow">in</span> <span class="n">ollama</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s2">&quot;status&quot;</span> <span class="ow">in</span> <span class="n">progress_info</span><span class="p">:</span>
                            <span class="n">status</span> <span class="o">=</span> <span class="n">progress_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
                            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="n">task</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Pulling </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">task</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[green]Model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; ready![/green]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold green]✓ Successfully pulled </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">[/bold green]&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; found locally&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error verifying/pulling Ollama model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="LyrebirdClient.make_request">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.LyrebirdClient.make_request">[docs]</a>
    <span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a chat completion request to the selected LLM provider.</span>

<span class="sd">        Args:</span>
<span class="sd">            system_prompt (str): The system role content.</span>
<span class="sd">            user_prompt (str): The user&#39;s input prompt.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The response content from the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">},</span>
            <span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making API request with provider: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Provider</span><span class="o">.</span><span class="n">openrouter</span><span class="p">,</span> <span class="n">Provider</span><span class="o">.</span><span class="n">deepseek</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">Provider</span><span class="o">.</span><span class="n">ollama</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported provider: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response: </span><span class="si">{</span><span class="n">result</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>  <span class="c1"># log first 80 chars</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]API Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>
</div>



<span class="c1"># Initialize Typer app</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lyrebird&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;🐦 Lyrebird CLI: AI-Powered Coding Assistant in Your Terminal&quot;</span><span class="p">,</span>
    <span class="n">add_completion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">rich_markup_mode</span><span class="o">=</span><span class="s2">&quot;rich&quot;</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="version_callback">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.version_callback">[docs]</a>
<span class="k">def</span> <span class="nf">version_callback</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show version information&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lyrebird CLI v</span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">()</span></div>



<div class="viewcode-block" id="read_input">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.read_input">[docs]</a>
<span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read input from a specified file or from standard input (stdin).</span>

<span class="sd">    Args:</span>
<span class="sd">        file (Optional[Path]): The path to the input file. If None,</span>
<span class="sd">                               the function checks for input from stdin.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The content read from the file or stdin.</span>

<span class="sd">    Raises:</span>
<span class="sd">        typer.Exit(1): If the specified file does not exist or if</span>
<span class="sd">                       there&#39;s an error reading the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error: File </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> does not exist[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error reading file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Check if there&#39;s input from stdin</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="format_output">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.format_output">[docs]</a>
<span class="k">def</span> <span class="nf">format_output</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_format</span><span class="p">:</span> <span class="n">OutputFormat</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format output according to the specified format.</span>

<span class="sd">    If `output_format` is `OutputFormat.json`, the content is wrapped in a JSON object</span>
<span class="sd">    along with task, timestamp, and version information. Otherwise, the raw content</span>
<span class="sd">    is returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        content (str): The primary content to be formatted.</span>
<span class="sd">        output_format (OutputFormat): The desired output format (e.g., `text`, `json`).</span>
<span class="sd">        task (str): A description of the task being performed (used in JSON output).</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The formatted output string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="n">OutputFormat</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">cwd</span><span class="p">()),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">content</span></div>



<div class="viewcode-block" id="display_code">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.display_code">[docs]</a>
<span class="k">def</span> <span class="nf">display_code</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display code with syntax highlighting using Rich&#39;s `Syntax` and `Panel`.</span>

<span class="sd">    Args:</span>
<span class="sd">        content (str): The code string to display.</span>
<span class="sd">        language (str): The programming language for syntax highlighting (default: &quot;python&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">syntax</span> <span class="o">=</span> <span class="n">Syntax</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;monokai&quot;</span><span class="p">,</span> <span class="n">line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">syntax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Generated Code&quot;</span><span class="p">,</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">))</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.main">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">version_callback</span><span class="p">,</span>
        <span class="n">is_eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show version and exit&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    🐦 Lyrebird CLI: AI-Powered Coding Assistant in Your Terminal</span>

<span class="sd">    This is the main callback for the Typer application, handling global options</span>
<span class="sd">    like `--version`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="generate">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.generate">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Task description for code generation&quot;</span><span class="p">),</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek or ollama)&quot;</span>
    <span class="p">),</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--file&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input file for context&quot;</span>
    <span class="p">),</span>
    <span class="n">language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;--lang&quot;</span><span class="p">,</span> <span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Programming language&quot;</span><span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output format&quot;</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable verbose logging&quot;</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate code from a natural language prompt.</span>

<span class="sd">    This command takes a natural language prompt and optional context from a file</span>
<span class="sd">    to generate code in a specified programming language. It interacts with an</span>
<span class="sd">    LLM provider (OpenRouter, DeepSeek, or Ollama) to produce the code.</span>

<span class="sd">    Args:</span>
<span class="sd">        prompt (str): A detailed description of the coding task.</span>
<span class="sd">        provider (Provider): The LLM service provider to use.</span>
<span class="sd">        file (Optional[Path]): An optional input file whose content will be</span>
<span class="sd">                               used as additional context for code generation.</span>
<span class="sd">        language (str): The programming language for the generated code (default: &quot;python&quot;).</span>
<span class="sd">        model (Optional[str]): The specific model name to use for code generation.</span>
<span class="sd">                                If not provided, a default model for the selected</span>
<span class="sd">                                provider will be used.</span>
<span class="sd">        output_format (OutputFormat): The desired format for the output</span>
<span class="sd">                                      (e.g., &quot;text&quot; for direct code display,</span>
<span class="sd">                                      &quot;json&quot; for structured output).</span>
<span class="sd">        verbose (bool): If True, enables verbose logging to display debug information.</span>

<span class="sd">    Raises:</span>
<span class="sd">        typer.Exit(1): If code generation fails due to API errors or other issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Read additional context if file provided</span>
    <span class="n">context</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">read_input</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">context_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Additional context from </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">```</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are an expert coding assistant specializing in </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2">. </span>
<span class="s2">Generate clean, well-commented, production-ready code that follows best practices.</span>
<span class="s2">Always include proper error handling where appropriate.&quot;&quot;&quot;</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Generate </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> code for: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}{</span><span class="n">context_info</span><span class="si">}</span>

<span class="s2">Requirements:</span>
<span class="s2">- Write clean, readable code</span>
<span class="s2">- Include appropriate comments</span>
<span class="s2">- Follow </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> best practices</span>
<span class="s2">- Include error handling where needed</span>
<span class="s2">- Make the code production-ready&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">SpinnerColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Generating code...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">display_code</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">format_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="s2">&quot;generate&quot;</span><span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="chat">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.chat">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">chat</span><span class="p">(</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek or ollama)&quot;</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a coding-focused chat session with the assistant.</span>

<span class="sd">    This command initiates an interactive chat session where users can ask</span>
<span class="sd">    coding-related questions and receive responses from the LLM. The session</span>
<span class="sd">    continues until the user types &#39;exit&#39; or &#39;quit&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        provider (Provider): The LLM service provider to use for the chat session.</span>
<span class="sd">        model (Optional[str]): The specific model name to use for chat responses.</span>
<span class="sd">                               If not provided, a default model for the selected</span>
<span class="sd">                               provider will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold green]Starting Chat Session. Type &#39;exit&#39; to quit.[/]&quot;</span><span class="p">)</span>
    <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Initialize LyrebirdClient for chat</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">Provider</span><span class="p">(</span><span class="n">provider</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Failed to initialize client: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;You: &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span> <span class="s2">&quot;quit&quot;</span><span class="p">]:</span>
            <span class="k">break</span>
        <span class="c1"># Use LyrebirdClient to generate a completion</span>
        <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;You are Lyrebird, an expert coding assistant designed for CLI use. &quot;</span>
            <span class="s2">&quot;Always provide clear, accurate, and concise responses tailored to software developers. &quot;</span>
            <span class="s2">&quot;Prefer code snippets over long explanations. Use bullet points for steps. &quot;</span>
            <span class="s2">&quot;If unsure, say so rather than guessing. &quot;</span>
            <span class="s2">&quot;When showing code, explain briefly what it does. Avoid unnecessary greetings or sign-offs.&quot;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">user_input</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user_input</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[cyan]Assistant:[/] </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="test">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.test">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek or ollama)&quot;</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate or enhance unit tests for a Python file.</span>

<span class="sd">    Given the source code of a Python file, this command leverages an LLM to</span>
<span class="sd">    produce new or improved unit tests to validate its functionality.</span>
<span class="sd">    The output is primarily the generated test code, preferably using pytest.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (Path): The path to the Python file for which to generate/improve tests.</span>
<span class="sd">                     The file must exist.</span>
<span class="sd">        provider (Provider): The LLM service provider to use for test generation.</span>
<span class="sd">        model (Optional[str]): The specific model name to use. If not provided,</span>
<span class="sd">                               a default model for the selected provider will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Generate or improve unit tests for the following code:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># Use LyrebirdClient for completion</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">Provider</span><span class="p">(</span><span class="n">provider</span><span class="p">),</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">system_prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;You are an expert Python developer and test writer. &quot;</span>
        <span class="s2">&quot;Given the source code, generate or improve unit tests to validate its functionality. &quot;</span>
        <span class="s2">&quot;Return only the test code, using pytest if possible.&quot;</span>
    <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="fix">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.fix">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fix</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File to fix (or read from stdin)&quot;</span>
    <span class="p">),</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek)&quot;</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output format&quot;</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable verbose logging&quot;</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fix bugs and errors in code.</span>

<span class="sd">    This command takes code from a file or stdin, identifies bugs, syntax errors,</span>
<span class="sd">    and logical issues, and then provides a corrected version of the code.</span>
<span class="sd">    It attempts to detect the programming language based on the file extension.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (Optional[Path]): The path to the file containing the code to fix.</span>
<span class="sd">                               If None, code will be read from stdin.</span>
<span class="sd">        provider (Provider): The LLM service provider to use for code fixing.</span>
<span class="sd">        model (Optional[str]): The specific model name to use. If not provided,</span>
<span class="sd">                               a default model for the selected provider will be used.</span>
<span class="sd">        output_format (OutputFormat): The desired format for the output</span>
<span class="sd">                                      (e.g., &quot;text&quot; for direct code display,</span>
<span class="sd">                                      &quot;json&quot; for structured output).</span>
<span class="sd">        verbose (bool): If True, enables verbose logging.</span>

<span class="sd">    Raises:</span>
<span class="sd">        typer.Exit(1): If no code is provided, or if code fixing fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Read code to fix</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">read_input</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[red]Error: No code provided to fix[/red]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Detect language from file extension or content</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>  <span class="c1"># default</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="n">ext_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;.py&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.js&quot;</span><span class="p">:</span> <span class="s2">&quot;javascript&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.java&quot;</span><span class="p">:</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.cpp&quot;</span><span class="p">:</span> <span class="s2">&quot;cpp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.c&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">ext_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are an expert </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> developer and debugger.</span>
<span class="s2">Fix bugs, syntax errors, and logical issues in the provided code.</span>
<span class="s2">Maintain the original functionality while improving code quality.&quot;&quot;&quot;</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Please fix all bugs and issues in this </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> code:</span>

<span class="s2">```</span><span class="si">{</span><span class="n">language</span><span class="si">}</span>
<span class="si">{</span><span class="n">code</span><span class="si">}</span>
<span class="s2">```</span>

<span class="s2">Requirements:</span>
<span class="s2">- Fix all syntax errors</span>
<span class="s2">- Resolve logical bugs</span>
<span class="s2">- Improve error handling</span>
<span class="s2">- Maintain original functionality</span>
<span class="s2">- Add comments explaining fixes</span>
<span class="s2">- Return only the corrected code&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">SpinnerColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Fixing code...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">display_code</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">format_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="s2">&quot;fix&quot;</span><span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Fix failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="refactor">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.refactor">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">refactor</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File to refactor (or read from stdin)&quot;</span>
    <span class="p">),</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek)&quot;</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output format&quot;</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable verbose logging&quot;</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refactor code for better performance and readability.</span>

<span class="sd">    This command takes code from a file or stdin and uses an LLM to refactor it.</span>
<span class="sd">    The refactoring aims to improve readability, performance, maintainability,</span>
<span class="sd">    and adherence to best practices, all while preserving original functionality.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (Optional[Path]): The path to the file containing the code to refactor.</span>
<span class="sd">                               If None, code will be read from stdin.</span>
<span class="sd">        provider (Provider): The LLM service provider to use for refactoring.</span>
<span class="sd">        model (Optional[str]): The specific model name to use. If not provided,</span>
<span class="sd">                               a default model for the selected provider will be used.</span>
<span class="sd">        output_format (OutputFormat): The desired format for the output.</span>
<span class="sd">        verbose (bool): If True, enables verbose logging.</span>

<span class="sd">    Raises:</span>
<span class="sd">        typer.Exit(1): If no code is provided, or if refactoring fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Read code to refactor</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">read_input</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[red]Error: No code provided to refactor[/red]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Detect language from file extension</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>  <span class="c1"># default</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="n">ext_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;.py&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.js&quot;</span><span class="p">:</span> <span class="s2">&quot;javascript&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.java&quot;</span><span class="p">:</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.cpp&quot;</span><span class="p">:</span> <span class="s2">&quot;cpp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.c&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">ext_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are an expert </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> developer focused on code optimization and best practices.</span>
<span class="s2">Refactor code to improve readability, performance, and maintainability while preserving functionality.&quot;&quot;&quot;</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Please refactor this </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> code for better quality:</span>

<span class="s2">```</span><span class="si">{</span><span class="n">language</span><span class="si">}</span>
<span class="si">{</span><span class="n">code</span><span class="si">}</span>
<span class="s2">```</span>

<span class="s2">Refactoring goals:</span>
<span class="s2">- Improve code readability</span>
<span class="s2">- Optimize performance where possible</span>
<span class="s2">- Follow </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> best practices</span>
<span class="s2">- Reduce code complexity</span>
<span class="s2">- Improve naming conventions</span>
<span class="s2">- Add proper documentation</span>
<span class="s2">- Maintain all original functionality</span>

<span class="s2">Return only the refactored code&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">SpinnerColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Refactoring code...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">display_code</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">format_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="s2">&quot;refactor&quot;</span><span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Refactoring failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="explain">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.explain">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">explain</span><span class="p">(</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File to explain (or read from stdin)&quot;</span>
    <span class="p">),</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek)&quot;</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output format&quot;</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable verbose logging&quot;</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Explain code functionality and structure.</span>

<span class="sd">    This command takes code from a file or stdin and provides a detailed explanation</span>
<span class="sd">    of its purpose, functionality, structure, algorithms, and design patterns.</span>
<span class="sd">    It aims to help users understand complex codebases.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (Optional[Path]): The path to the file containing the code to explain.</span>
<span class="sd">                               If None, code will be read from stdin.</span>
<span class="sd">        provider (Provider): The LLM service provider to use for explanation.</span>
<span class="sd">        model (Optional[str]): The specific model name to use. If not provided,</span>
<span class="sd">                               a default model for the selected provider will be used.</span>
<span class="sd">        output_format (OutputFormat): The desired format for the output.</span>
<span class="sd">        verbose (bool): If True, enables verbose logging.</span>

<span class="sd">    Raises:</span>
<span class="sd">        typer.Exit(1): If no code is provided, or if the explanation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Read code to explain</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">read_input</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[red]Error: No code provided to explain[/red]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Detect language from file extension</span>
    <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>  <span class="c1"># default</span>
    <span class="k">if</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="n">ext_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;.py&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.js&quot;</span><span class="p">:</span> <span class="s2">&quot;javascript&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.java&quot;</span><span class="p">:</span> <span class="s2">&quot;java&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.cpp&quot;</span><span class="p">:</span> <span class="s2">&quot;cpp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.c&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">ext_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are an expert </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> developer and technical communicator.</span>
<span class="s2">Provide clear, comprehensive explanations of code functionality, structure, and implementation details.&quot;&quot;&quot;</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Please explain this </span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s2"> code in detail:</span>

<span class="s2">```</span><span class="si">{</span><span class="n">language</span><span class="si">}</span>
<span class="si">{</span><span class="n">code</span><span class="si">}</span>
<span class="s2">```</span>

<span class="s2">Explanation should include:</span>
<span class="s2">- Overall purpose and functionality</span>
<span class="s2">- Key algorithms and data structures used</span>
<span class="s2">- Flow of execution</span>
<span class="s2">- Important design patterns</span>
<span class="s2">- Potential improvements or considerations</span>
<span class="s2">- Any notable implementation details</span>
<span class="s2">- How different parts work together&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">SpinnerColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Analyzing code...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="n">Panel</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Code Explanation&quot;</span><span class="p">,</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">format_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="s2">&quot;explain&quot;</span><span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Explanation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="summarize">
<a class="viewcode-back" href="../../lyrebird.html#lyrebird.cli.summarize">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span>
    <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Argument</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory to summarize&quot;</span><span class="p">),</span>
    <span class="n">provider</span><span class="p">:</span> <span class="n">Provider</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="s2">&quot;--provider&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;API provider to use (openrouter or deepseek)&quot;</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--model&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Model to use&quot;</span><span class="p">),</span>
    <span class="n">output_format</span><span class="p">:</span> <span class="n">OutputFormat</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output format&quot;</span>
    <span class="p">),</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable verbose logging&quot;</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summarize codebase structure and architecture.</span>

<span class="sd">    This command analyzes a given directory, identifies common code files,</span>
<span class="sd">    and provides a high-level summary of the codebase&#39;s architecture,</span>
<span class="sd">    main components, technology stack, design patterns, and overall functionality.</span>
<span class="sd">    It helps in quickly grasping the essence of a project.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (Path): The path to the directory containing the codebase to summarize.</span>
<span class="sd">                          The directory must exist.</span>
<span class="sd">        provider (Provider): The LLM service provider to use for summarization.</span>
<span class="sd">        model (Optional[str]): The specific model name to use. If not provided,</span>
<span class="sd">                               a default model for the selected provider will be used.</span>
<span class="sd">        output_format (OutputFormat): The desired format for the output.</span>
<span class="sd">        verbose (bool): If True, enables verbose logging.</span>

<span class="sd">    Raises:</span>
<span class="sd">        typer.Exit(1): If the provided path is not a valid directory, if no code</span>
<span class="sd">                       files are found, or if the summarization fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">LyrebirdClient</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error: </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2"> is not a valid directory[/red]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Collect code files</span>
    <span class="n">code_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.py&quot;</span><span class="p">,</span> <span class="s2">&quot;.js&quot;</span><span class="p">,</span> <span class="s2">&quot;.java&quot;</span><span class="p">,</span> <span class="s2">&quot;.cpp&quot;</span><span class="p">,</span> <span class="s2">&quot;.c&quot;</span><span class="p">,</span> <span class="s2">&quot;.h&quot;</span><span class="p">,</span> <span class="s2">&quot;.ts&quot;</span><span class="p">,</span> <span class="s2">&quot;.jsx&quot;</span><span class="p">,</span> <span class="s2">&quot;.tsx&quot;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
        <span class="n">code_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">directory</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">code_files</span><span class="p">:</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]No code files found in </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Limit files to avoid token limits</span>
    <span class="n">code_files</span> <span class="o">=</span> <span class="n">code_files</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>  <span class="c1"># Limit to first 20 files</span>

    <span class="n">file_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">code_files</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="c1"># Truncate very large files</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">... (truncated)&quot;</span>
            <span class="n">file_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="si">}</span><span class="s2"> ---</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">total_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="c1"># Prevent extremely large prompts</span>
            <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="n">codebase_content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>

    <span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You are an expert software architect and code analyst.</span>
<span class="s2">Analyze codebases and provide comprehensive architectural summaries.&quot;&quot;&quot;</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Analyze this codebase and provide a comprehensive summary:</span>

<span class="si">{</span><span class="n">codebase_content</span><span class="si">}</span>

<span class="s2">Please provide:</span>
<span class="s2">- Overall architecture and structure</span>
<span class="s2">- Main components and modules</span>
<span class="s2">- Technology stack used</span>
<span class="s2">- Design patterns observed</span>
<span class="s2">- Key functionality and features</span>
<span class="s2">- Data flow and interactions</span>
<span class="s2">- Code quality observations</span>
<span class="s2">- Potential areas for improvement&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">SpinnerColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[progress.description]</span><span class="si">{task.description}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;Analyzing codebase...&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">)</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="n">OutputFormat</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="n">Panel</span><span class="p">(</span>
                        <span class="n">result</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Codebase Summary: </span><span class="si">{</span><span class="n">directory</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">format_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="s2">&quot;summarize&quot;</span><span class="p">)</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">formatted_output</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Analysis failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, lyrebird-team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>